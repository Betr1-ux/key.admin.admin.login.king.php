<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KING ADMIN - Generate Codes</title>
  <style>
    body { background:#000; color:#0f0; font-family:Arial; padding:20px; }
    h2 { color:#0f0; }
    input, button { padding:8px; margin:5px; border-radius:8px; border:none; }
    input { width:120px; text-align:center; }
    button { background:#0f0; color:#000; cursor:pointer; font-weight:bold; }
    button:hover { background:#3f3; }
    table { border-collapse:collapse; width:100%; margin-top:15px; }
    th, td { border:1px solid #0f0; padding:6px; text-align:center; }
  </style>
</head>
<body>

<h2>لوحة توليد الأكواد</h2>

<label>عدد الأكواد:</label>
<input type="number" id="numCodes" value="5" min="1" max="100"><br>
<label>عدد الاستخدامات لكل كود:</label>
<input type="number" id="uses" value="1" min="1"><br>
<button onclick="generateCodes()">توليد</button>
<button onclick="clearAll()">مسح الكل</button>

<h3>الأكواد المتاحة</h3>
<table>
  <thead>
    <tr>
      <th>الكود</th>
      <th>الاستخدامات المتبقية</th>
    </tr>
  </thead>
  <tbody id="codesTable"></tbody>
</table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAF1K59iKFsVH-wyAKyGw2wsIMUIrT9WMg",
    authDomain: "admin-3fd30.firebaseapp.com",
    databaseURL: "https://admin-3fd30-default-rtdb.firebaseio.com",
    projectId: "admin-3fd30",
    storageBucket: "admin-3fd30.firebasestorage.app",
    messagingSenderId: "981773176798",
    appId: "1:981773176798:web:1ebc106e60af04ed8a174f",
    measurementId: "G-35L6036ED8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // === مولّد على نمط: XXXXX-XXXXX-XXXXX-XXXXX (HEX فقط) ===
  function randomHexCode(){
    const HEX = "0123456789ABCDEF";
    const parts = [];
    for(let g=0; g<4; g++){
      let seg = "";
      for(let i=0; i<5; i++){
        seg += HEX[Math.floor(Math.random()*HEX.length)];
      }
      parts.push(seg);
    }
    return parts.join("-");
  }

  // توليد مع ضمان عدم تكرار الأكواد الموجودة بالفعل
  window.generateCodes = async function(){
    const num = parseInt(document.getElementById("numCodes").value);
    const uses = parseInt(document.getElementById("uses").value);

    const snap = await get(ref(db, "codes"));
    const existing = new Set(snap.exists() ? Object.keys(snap.val()) : []);

    const newCodes = [];
    while(newCodes.length < num){
      const code = randomHexCode();
      if(!existing.has(code)){
        existing.add(code);
        newCodes.push(code);
      }
    }

    await Promise.all(newCodes.map(c => set(ref(db, "codes/" + c), { remaining: uses })));
    renderTable();
  }

  async function renderTable(){
    const snapshot = await get(ref(db, "codes"));
    const tbody = document.getElementById("codesTable");
    tbody.innerHTML = "";
    if(snapshot.exists()){
      const data = snapshot.val();
      Object.keys(data).sort().forEach(code=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${code}</td><td>${data[code].remaining}</td>`;
        tbody.appendChild(tr);
      });
    }
  }

  // حذف مباشر بدون تأكيد
  window.clearAll = async function(){
    await remove(ref(db, "codes"));
    renderTable();
  }

  renderTable();
</script>
</body>
</html>
